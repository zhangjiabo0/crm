<include file="Public:header" />
<style>
/*重置*/
.flow-schedule,.flow-schedule li{ list-style: none; margin: 0; padding: 0;}
.flow-schedule li{ float:left; font-size:12px; color:#6c706a; height:24px; line-height:24px; padding:0 10px;}
.flow-schedule .li1{ background:#cbdd9f;}
.flow-schedule .li2{ background:#f3bd7c;}
.flow-schedule .li3{ background:#d8dad8;}
</style>
<div class="container">
		<div class="page-header">
			<h4>{:L('THE_VIEW_CONTRACT')}</h4>
		</div>
        <div class="row">
			<div class="span12">
				<include file="Public:alert"/>
				<form action="{:U('priceSheet/add')}" method="post">
				    <input type="hidden" name="refer_url" value="{$refer_url}">
				    <input type="hidden" id="add_file" name="add_file" value="{$leadsB.add_file}">
				    <input type="hidden" name="id" id="id" value="{$vo.id}">
				    <input type="hidden" name="fid" id="fid" value="{$vo['flow']['id']}">
					<table class="table" width="95%" border="0" cellspacing="1" cellpadding="0">
						<tbody width="100%">
							<tr><th <if condition="C('ismobile') eq 1">colspan="2"<else />colspan="4"</if>>{:L('BASIC_INFO')}</th></tr>
							<tr>
								<td width="15%" class="tdleft">{:L('CONTRACT_NO')}</td>
								<td width="35%"><input  type="text" name="number" id="number" value="{$vo.number}"></td>
								<td width="15%" class="tdleft">{:L('SOURCE_OF_CUSTOMERS')}</td>
								<td width="35%" colspan="3">
									<input type="text" name="customer_id" id="customer_id" value="{$vo.customer_name}"/>
								</td>
							</tr>
							<tr>
								<td class="tdleft" >{:L('SERVICE_NAME')}</td>
								<td><input type="text" name="customerB_id" id="customerB_id" value="{$vo.service_name}" /></td>
							
								<td class="tdleft">{:L('OWNER_ROLE')}</td>
								<td>
									<input readonly="readonly" type="text" name="owner_role_name" id="owner_name" value="{$vo.user_name}_{$vo.true_name}"/>
								</td>
							</tr>
							<tr>
								<td class="tdleft">{:L('DEPARTMENT')}</td>
								<td colspan="3"><input type="text" name="department" id="department" value="{$vo.department}" readonly="readonly"/></td>
							</tr>
							<tr>
								<td class="tdleft">{:L('APPLY_REASON')}</td>
								<td <if condition="C('ismobile') neq 1">colspan="3"</if>><textarea class="span6" rows="3" name="reason" id="reason">{$vo.reason}</textarea></td>
							</tr>
							<tr>
	                        	<td class="tdleft" width="15%">附件:</td>
	                        	<if condition="$vo['add_file'] eq ''">
	                            	<td width="35%">{:W('File',array('add_file'=>$vo['add_file'],'mode'=>'add'))}</td>
	                            <else/>
	                            	<td width="35%">{:W('File',array('add_file'=>$vo['add_file'],'mode'=>'show'))}</td>
	                            </if>
                       	 	</tr>
							<tr>
							<th colspan="4">{:L('RELATED_PRODUCTS')}</th>
						</tr>
						<tr>
							<td style="padding:0px;" colspan="4">
								<!-- 隐藏域 -->
								<input type="hidden" name="subtotal_val" class="subtotal_val" value=""/>
								<input type="hidden" name="total_amount" class="total_amount" value=""/>
								<input type="hidden" name="willtotal_val" class="willtotal_val" value=""/>
								<input type="hidden" name="service_val" class="service_val" value=""/>
								<!-- 隐藏域 END-->
								<table class="table table-bordered" id="no-input-border" width="95%" border="0" cellspacing="1" cellpadding="0">
									<thead>
										<tr style="background-color:#E0E8FF;text-align:center;">
											<td class="span2">产品</td>
											<td>数量</td>
											<td>标准目录价</td>
											<td>金额</td>
											<td style="width: 75px;">客户意向单价</td>
											<td>客户意向金额</td>
											<td>服务商单价</td>
											<td>服务商金额</td>
											<td>折扣</td>
											<td>利润率</td>
											<td>政策说明</td>
											<td class="span2">备注</td>
										</tr>
									</thead>
									<tbody id="add_products">
										<foreach name="vo.products" item="v">
											<tr>
												<td><input type="text" value="{$v.product_name}" title="{$v.product_name}" readonly="readonly"/></td>
												<td>{$v.amount}</td>
												<td class="unit_price">{$v.unit_price}</td>
												<td>{$v.subtotal}</td>
												<td class="will_price">{$v.will_price}</td>
												<td>{$v.will_total}</td>
												<td>{$v.provider_price}</td>
												<td>{$v.provider_total}</td>
												<td class="tax_rate">{$v.tax_rate}</td>
												<td class="lirun">{$v.lirun}</td>
												<td><input type="text" value="{$v.discount_rate}" title="{$v.discount_rate}" readonly="readonly"/></td>
												<td><input type="text" value="{$v.discription}" title="{$v.discription}" readonly="readonly"/></td>
											</tr>
										</foreach>
									</tbody>
									<tbody id="add_pro">
										<tr style="background-color:#FFFFF3;color:#808080">
											<td>合计</td>
											<td id="total_amount_val" style="text-align:center">{$vo.total_amount}</td>
											<td></td>
											<td id="subtotal_val" style="text-align:center" name="subtotal_val">{$vo.subtotal_val}</td>
											<td></td>
											<td id="willtotal_val" style="text-align:center" name="willtotal_val">{$vo.willtotal_val}</td>
											<td></td>
											<td id="service_val" style="text-align:center" name="service_val">{$vo.service_val}</td>
											<td></td>
											<td></td>
											<td></td>
											<td></td>
										</tr>
									</tbody> 
								</table>
							</td>
						</tr>
						<if condition="$vo['isflow']">
							<tr>
								<td class="tdleft">意见</td>
								<td><textarea class="span6" rows="3" name="opinion" id="opinion"></textarea></td>
							</tr>
						</if>
						</tbody>
						<tfoot>
							<tr>
								<td colspan="2">
									<if condition="$vo['isflow']">
										<input name="buttom" class="btn btn-danger pull-right" type="button" value="拒绝" onclick="flowSbu(0)"/>
										<input name="buttom" class="btn btn-primary pull-right" type="button" value="同意" onclick="flowSbu(1)"/>
									</if> 
								</td>
								<td colspan="2">
									<input class="btn btn-primary" type="button" onclick="javascript:history.go(-1)" value="{:L('RETURN')}"/>&nbsp;&nbsp;
								</td>
							</tr>
						</tfoot>
					</table>
				</form>
			</div>
		</div>
		<div class="back_box" style="margin-top:10px;">
				<!-- 流程 -->
					<ul class="flow-schedule" style="margin-bottom: 20px;padding-bottom: 20px;">
						<li class="li1">开始</li>
						<volist name="flow_all" id="vv">
							<if condition="$vv.title eq '申请人'">
								<li>→</li>
						    	<li class="{$vv.class}"><a title="{$vv.name}">申请人</a></li>
						    <else/>
						    	<li>→</li>
						    	<li class="{$vv.class}"><a title="{$vv.name}">{$vv.position_name}</a></li>
							</if>
					    </volist>
					    <li>→</li>
					    <li class="li3">结束</li>
					</ul>
				
					<table class="table back_box">
						<thead>
							<tr>
								<td>{:L('TITLE')}</td>
								<td>{:L('RESULT')}</td>
								<td>{:L('COMMENT')}</td>
								<td>{:L('CONFIRM_NAME')}</td>
								<td>{:L('CONFIRM_TIME')}</td>
							</tr>
						</thead>
						<tbody>
							<if condition="$vo.is_del eq '1'">
								<tr>
									<td>申请人作废</td>
									<td>作废</td>
									<td></td>
									<td>{$info['role_id']|get_user_info="true_name",###}</td>
									<td>{$info.update_time|date="Y-m-d H:i:s",###}</td>
								</tr>
							</if>
							<volist name="flowlog" id="v">
								<tr>
									<td>{$v.title}</td>
									<td>{$v.result|show_result}</td>
									<td>{$v.comment}</td>
									<td>{$v.user_name}</td>
									<td>{$v.update_time|date="Y-m-d H:i:s",###}</td>
								</tr>
							</volist>
							<tr>
								<td>申请人创建</td>
								<td>创建</td>
								<td></td>
								<td>{$vo['role_id']|get_user_info="true_name",###}</td>
								<td>{$vo.create_time|date="Y-m-d H:i:s",###}</td>
							</tr>
						</tbody>
					</table>
				</div>
	</div>
<script type="text/javascript">
$(window).load(function(){
	init_style();
});
function  init_style(){
	$("#add_products tr").each(function(){
		$(this).find("input").attr('style','text-decoration: underline;color:blue;');
		var will = $(this).find(".will_price");
		var unit = $(this).find(".unit_price");
		if(will.text().trim() != unit.text().trim()){
			will.attr('style','background-color:red;color:#fff;');
		}else{
			will.attr('style','');
		}
		var tax = $(this).find(".tax_rate");
		var lirun = $(this).find(".lirun");
		if(tax.text().trim() <= 8){
			tax.attr('style','color:red;');
		}else{
			tax.attr('style','');
		}
		var tmp = lirun.text().trim().split('%');
		if(tmp[0] <= 20){
			lirun.attr('style','color:red;');
		}else{
			lirun.attr('style','');
		}
	});
}
function flowSbu(re){
	var id = $("#id").val().trim();
	var fid = $("#fid").val().trim();
	var comm = $("#opinion").val().trim();
	$.ajax({
	     type: 'POST',
	     url: "{:U('flowlog')}" ,
	    data: {id:id,fid:fid,re:re,comm:comm} ,
	    dataType: 'json',
	    success:  function(data){
	    	if(data == '1'){
	    		alert('修改成功!');
	    	}else{
	    		alert('修改失败');
	    	}
	    	location.reload();
	    	return false;
	    },
	    error: function(){
	    	alert('修改失败...');
	    	return false;
	    }
	});
	
}
	
	
</script>
<include file="Public:footer" />	